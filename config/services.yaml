# config/services.yaml
imports:
    - { resource: 'parameters.yaml' }

services:
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.
        public: false

    # Makes classes in src/ available to be used as services.
    # This creates a service per class whose id is the fully qualified class name.
    MagicSunday\Memories\:
        resource: '../src/*'
        exclude:
            - '../src/{Memories,Dependencies}.php'
            - '../src/Entity/'

    _instanceof:
        Symfony\Component\Console\Command\Command:
            tags: ['command']

    MagicSunday\Memories\Application:
        public: true
        arguments:
            $commands: !tagged command

    MagicSunday\Memories\Utility\LocationHelper:
        arguments:
            $preferredLocale: '%memories.localization.preferred_locale%'

    ########################################
    # Doctrine EntityManager (ORM 3.5+)
    ########################################
    MagicSunday\Memories\Doctrine\EntityManagerFactory: ~

    # Doctrine EntityManager service and alias for autowiring
    Doctrine\ORM\EntityManagerInterface:
        factory: ['@MagicSunday\Memories\Doctrine\EntityManagerFactory', 'create']
        public: true

    Doctrine\ORM\EntityManager:
        alias: Doctrine\ORM\EntityManagerInterface

    ########################################
    # Thumbnail Service
    ########################################
    MagicSunday\Memories\Service\Thumbnail\ThumbnailService:
        arguments:
            $thumbnailDir: '%env(string:MEMORIES_THUMBNAIL_DIR)%'
            $sizes: '%memories.thumbnail_sizes%'

    MagicSunday\Memories\Service\Thumbnail\ThumbnailServiceInterface:
        alias: MagicSunday\Memories\Service\Thumbnail\ThumbnailService

    ########################################
    # Metadata Extractors & Enricher
    ########################################
    MagicSunday\Memories\Service\Metadata\ExifMetadataExtractor:
        arguments:
            $readExifForVideos: false

    MagicSunday\Memories\Service\Metadata\XmpIptcExtractor: ~

    MagicSunday\Memories\Service\Metadata\FilenameKeywordExtractor: ~

    MagicSunday\Memories\Service\Metadata\AppleHeuristicsExtractor: ~

    MagicSunday\Memories\Service\Metadata\GeoFeatureEnricher:
        arguments:
            $homeLat: '%env(float:MEMORIES_HOME_LAT)%'
            $homeLon: '%env(float:MEMORIES_HOME_LON)%'
            $cellDegrees: 0.01

    MagicSunday\Memories\Service\Metadata\CalendarFeatureEnricher: ~

    MagicSunday\Memories\Service\Metadata\DaypartEnricher: ~

    MagicSunday\Memories\Service\Metadata\SolarEnricher:
        arguments:
            $goldenMinutes: 60

    MagicSunday\Memories\Service\Metadata\VisionSignatureExtractor:
        arguments:
            $sampleSize: 320

    MagicSunday\Memories\Service\Metadata\FfprobeMetadataExtractor:
        arguments:
            $ffprobePath: '%env(string:FFPROBE_PATH)%'
            $slowMoFpsThreshold: 100.0

    MagicSunday\Memories\Service\Metadata\PerceptualHashExtractor:
        arguments:
            $dctSampleSize: '%memories.hash.dct_sample%'
            $lowFreqSize: '%memories.hash.lowfreq%'

    MagicSunday\Memories\Service\Metadata\CompositeMetadataExtractor:
        arguments:
            $extractors:
                - '@MagicSunday\Memories\Service\Metadata\ExifMetadataExtractor'
                - '@MagicSunday\Memories\Service\Metadata\XmpIptcExtractor'
                - '@MagicSunday\Memories\Service\Metadata\FilenameKeywordExtractor'
                - '@MagicSunday\Memories\Service\Metadata\AppleHeuristicsExtractor'
                - '@MagicSunday\Memories\Service\Metadata\GeoFeatureEnricher'
                - '@MagicSunday\Memories\Service\Metadata\CalendarFeatureEnricher'
                - '@MagicSunday\Memories\Service\Metadata\DaypartEnricher'
                - '@MagicSunday\Memories\Service\Metadata\SolarEnricher'
                - '@MagicSunday\Memories\Service\Metadata\VisionSignatureExtractor'
                - '@MagicSunday\Memories\Service\Metadata\FfprobeMetadataExtractor'
                - '@MagicSunday\Memories\Service\Metadata\PerceptualHashExtractor'

    MagicSunday\Memories\Service\Metadata\MetadataExtractorInterface:
        alias: MagicSunday\Memories\Service\Metadata\CompositeMetadataExtractor

    ########################################
    # Geocoding
    ########################################

    # Einfach: Interface direkt per Factory bereitstellen (kein 'http_client' Alias n√∂tig)
    Symfony\Contracts\HttpClient\HttpClientInterface:
        factory: ['Symfony\Component\HttpClient\HttpClient', 'create']
        arguments:
            - {
                headers: {
                    'User-Agent': '%memories.geocoding.nominatim.user_agent% (%memories.geocoding.nominatim.email%)',
                    'Accept': 'application/json'
                },
              # optional: Timeout/Verify/Base-URI etc.
                max_redirects: 5,
                timeout: 10.0
            }

    MagicSunday\Memories\Service\Geocoding\NominatimReverseGeocoder:
        arguments:
            $http: '@Symfony\Contracts\HttpClient\HttpClientInterface'
            $baseUrl: '%memories.geocoding.nominatim.base_url%'
            $userAgent: '%memories.geocoding.nominatim.user_agent%'
            $contactEmail: '%memories.geocoding.nominatim.email%'
            $zoom: '%memories.geocoding.nominatim.zoom%'

    MagicSunday\Memories\Service\Geocoding\ReverseGeocoderInterface:
        alias: MagicSunday\Memories\Service\Geocoding\NominatimReverseGeocoder

    MagicSunday\Memories\Service\Geocoding\OverpassClient:
        arguments:
            $http: '@Symfony\Contracts\HttpClient\HttpClientInterface'
            $baseUrl: '%memories.geocoding.overpass.base_url%'
            $userAgent: '%memories.geocoding.nominatim.user_agent%'
            $contactEmail: '%memories.geocoding.nominatim.email%'
            $queryTimeout: '%memories.geocoding.overpass.timeout%'
            $httpTimeout: '%memories.geocoding.overpass.timeout%'
            $additionalAllowedTags: '%memories.geocoding.overpass.allowed_pois%'

    MagicSunday\Memories\Service\Geocoding\LocationPoiEnricher:
        arguments:
            $radiusMeters: '%memories.geocoding.overpass.radius_m%'
            $maxPois: '%memories.geocoding.overpass.max_pois%'
            $fetchLimitMultiplier: '%memories.geocoding.overpass.fetch_limit_multiplier%'

    MagicSunday\Memories\Service\Geocoding\LocationCellIndex: ~

    MagicSunday\Memories\Service\Geocoding\LocationResolver:
        arguments:
            $cellDeg: 0.01
            $poiEnricher: '@MagicSunday\Memories\Service\Geocoding\LocationPoiEnricher'

    MagicSunday\Memories\Service\Geocoding\MediaLocationLinker:
        arguments:
            $cellDeg: 0.01

    MagicSunday\Memories\Command\GeocodeCommand:
        arguments:
            $delayMs: '%memories.geocoding.delay_ms%'
        tags: ['console.command']


    ########################################
    # Clustering
    ########################################

    MagicSunday\Memories\Clusterer\TimeSimilarityStrategy:
        arguments:
            $maxGapSeconds: 10800   # 3h keeps sessions cohesive without spanning full days
            $minItemsPerBucket: 9
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.time_similarity_strategy%' }

    MagicSunday\Memories\Clusterer\LocationSimilarityStrategy:
        arguments:
            $radiusMeters: 140.0
            $minItemsPerPlace: 6
            $maxSpanHours: 16
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.location_similarity_strategy%' }

    MagicSunday\Memories\Clusterer\DeviceSimilarityStrategy:
        arguments:
            $minItemsPerGroup: 5
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.device_similarity_strategy%' }

    MagicSunday\Memories\Clusterer\PhashSimilarityStrategy:
        arguments:
            $maxHamming: 7
            $minItemsPerBucket: 2
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.phash_similarity_strategy%' }

    # --- Composition & session heuristics ---
    MagicSunday\Memories\Clusterer\BurstClusterStrategy:
        arguments:
            $maxGapSeconds: 90
            $maxMoveMeters: 45.0
            $minItemsPerBurst: 3
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.burst_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PhotoMotifClusterStrategy:
        arguments:
            $sessionGapSeconds: 86400   # 24h keeps multi-day motifs together without spanning weeks
            $minItemsPerMotif: 7
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.photo_motif_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\CrossDimensionClusterStrategy:
        arguments:
            $timeGapSeconds: 5400        # 1.5h blends adjacent scene
            $radiusMeters: 130.0
            $minItemsPerRun: 5
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.cross_dimension_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PanoramaClusterStrategy:
        arguments:
            $minAspect: 2.3
            $sessionGapSeconds: 9000   # 2.5h
            $minItemsPerRun: 3
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.panorama_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PanoramaOverYearsClusterStrategy:
        arguments:
            $minAspect: 2.3
            $minItemsPerYear: 2
            $minYears: 3
            $minItemsTotal: 10
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.panorama_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PortraitOrientationClusterStrategy:
        arguments:
            $minPortraitRatio: 1.2
            $sessionGapSeconds: 7200      # 2h
            $minItemsPerRun: 4
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.portrait_orientation_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\VideoStoriesClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 2
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.video_stories_cluster_strategy%' }

    # --- Daily life & home rituals ---
    MagicSunday\Memories\Clusterer\DayAlbumClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 7
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.day_album_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\MorningCoffeeClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $sessionGapSeconds: 4800      # 1h20m keeps morning rituals tight
            $radiusMeters: 180.0
            $minItemsPerRun: 3
            $minHour: 7
            $maxHour: 10
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.morning_coffee_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\AtHomeWeekendClusterStrategy:
        arguments:
            $homeLat: '%env(float:MEMORIES_HOME_LAT)%'
            $homeLon: '%env(float:MEMORIES_HOME_LON)%'
            $homeRadiusMeters: 260.0
            $minHomeShare: 0.62
            $minItemsPerDay: 3
            $minItemsTotal: 6
            $timezone: 'Europe/Berlin'
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.at_home_weekend_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\AtHomeWeekdayClusterStrategy:
        arguments:
            $homeLat: '%env(float:MEMORIES_HOME_LAT)%'
            $homeLon: '%env(float:MEMORIES_HOME_LON)%'
            $homeRadiusMeters: 250.0
            $minHomeShare: 0.60
            $minItemsPerDay: 3
            $minItemsTotal: 5
            $timezone: 'Europe/Berlin'
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.at_home_weekday_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\DiningOutClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $sessionGapSeconds: 5400   # 1.5h
            $radiusMeters: 200.0
            $minItemsPerRun: 4
            $minHour: 17
            $maxHour: 23
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.dining_out_cluster_strategy%' }

    # --- Social celebrations & people ---
    MagicSunday\Memories\Clusterer\AnniversaryClusterStrategy:
        arguments:
            $minItemsPerAnniversary: 5
            $minDistinctYears: 10
            $maxClusters: 30
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.anniversary_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PersonCohortClusterStrategy:
        arguments:
            $minPersons: 2
            $minItemsTotal: 4
            $windowDays: 10
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.person_cohort_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\KidsBirthdayPartyClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $sessionGapSeconds: 9600      # 2h40m keeps party blocks intact
            $radiusMeters: 230.0
            $minItemsPerRun: 5
            $minHour: 10
            $maxHour: 21
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.kids_birthday_party_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PetMomentsClusterStrategy:
        arguments:
            $sessionGapSeconds: 7200   # 2h
            $minItemsPerRun: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.pet_moments_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\HolidayEventClusterStrategy:
        arguments:
            $minItemsPerHoliday: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.holiday_event_cluster_strategy%' }

    # --- Special outings & events ---
    MagicSunday\Memories\Clusterer\NightlifeEventClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $timeGapSeconds: 9000        # 2.5h keeps multi-venue nights linked
            $radiusMeters: 260.0
            $minItemsPerRun: 5
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.nightlife_event_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\SportsEventClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $sessionGapSeconds: 9000     # 2.5h
            $radiusMeters: 480.0
            $minItemsPerRun: 8
            $preferWeekend: true
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.sports_event_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\FestivalSummerClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $sessionGapSeconds: 9000     # 2.5h
            $radiusMeters: 480.0
            $minItemsPerRun: 8
            $startMonth: 6
            $endMonth: 9
            $afternoonStartHour: 14
            $lateNightCutoffHour: 2
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.festival_summer_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\NewYearEveClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $startHour: 20
            $endHour: 2
            $minItemsPerYear: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.new_year_eve_cluster_strategy%' }

    # --- Travel & outdoor adventures ---
    MagicSunday\Memories\Clusterer\VacationClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $defaultHomeRadiusKm: 15.0
            $minAwayDistanceKm: 120.0
            $movementThresholdKm: 35.0
            $minItemsPerDay: 3
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.vacation_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\WeekendGetawaysOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minNights: 1
            $maxNights: 3
            $minItemsPerDay: 4
            $minYears: 3
            $minItemsTotal: 20
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.weekend_getaways_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\HikeAdventureClusterStrategy:
        arguments:
            $sessionGapSeconds: 9000     # 2.5h
            $minDistanceKm: 5.5
            $minItemsPerRun: 5
            $minItemsPerRunNoGps: 9
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.hike_adventure_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\CampingTripClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 3
            $minNights: 2
            $maxNights: 14
            $minItemsTotal: 16
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.camping_trip_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\CampingOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 3
            $minNights: 2
            $maxNights: 14
            $minYears: 3
            $minItemsTotal: 18
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.camping_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\BeachOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 6
            $minYears: 3
            $minItemsTotal: 18
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.beach_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\SnowVacationOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 4
            $minNights: 3
            $maxNights: 14
            $minYears: 3
            $minItemsTotal: 24
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.snow_vacation_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\TransitTravelDayClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minTravelKm: 70.0
            $minItemsPerDay: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.transit_travel_day_cluster_strategy%' }

    # --- Place-based explorations ---
    MagicSunday\Memories\Clusterer\FirstVisitPlaceClusterStrategy:
        arguments:
            $gridDegrees: 0.01
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 4
            $minNights: 0
            $maxNights: 3
            $minItemsTotal: 7
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.first_visit_place_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\SignificantPlaceClusterStrategy:
        arguments:
            $gridDegrees: 0.01
            $minVisitDays: 3
            $minItemsTotal: 16
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.significant_place_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\CityscapeNightClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $sessionGapSeconds: 6000      # 1h40m balances blue-hour transitions
            $radiusMeters: 260.0
            $minItemsPerRun: 5
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.cityscape_night_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\ZooAquariumClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $sessionGapSeconds: 6600      # 1h50m keeps exhibits contiguous
            $radiusMeters: 260.0
            $minItemsPerRun: 5
            $minHour: 9
            $maxHour: 20
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.zoo_aquarium_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\ZooAquariumOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 5
            $minYears: 3
            $minItemsTotal: 15
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.zoo_aquarium_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\MuseumOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 5
            $minYears: 3
            $minItemsTotal: 15
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.museum_over_years_cluster_strategy%' }

    # --- Weather & seasonal highlights ---
    MagicSunday\Memories\Clusterer\SeasonClusterStrategy:
        arguments:
            $minItemsPerSeason: 18
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.season_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\SeasonOverYearsClusterStrategy:
        arguments:
            $minYears: 3
            $minItemsPerSeason: 26
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.season_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\SunnyDayClusterStrategy:
        arguments:
            $minAvgSunScore: 0.65
            $minItemsPerDay: 5
            $minHintsPerDay: 2
            $timezone: 'Europe/Berlin'
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.sunny_day_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\RainyDayClusterStrategy:
        arguments:
            $minAvgRainProb: 0.6
            $minItemsPerDay: 5
            $timezone: 'Europe/Berlin'
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.rainy_day_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\SnowDayClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $sessionGapSeconds: 7200      # 2h
            $minItemsPerRun: 5
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.snow_day_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\GoldenHourClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $morningHours:
                - 6
                - 7
                - 8
            $eveningHours:
                - 18
                - 19
                - 20
            $sessionGapSeconds: 5400
            $minItemsPerRun: 4
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.golden_hour_cluster_strategy%' }

    # --- Temporal retrospectives ---
    MagicSunday\Memories\Clusterer\ThisMonthOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minYears: 3
            $minItemsTotal: 20
            $minDistinctDays: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.this_month_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\OnThisDayOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $windowDays: 0
            $minYears: 3
            $minItemsTotal: 10
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.on_this_day_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\OneYearAgoClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $windowDays: 3
            $minItemsTotal: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.one_year_ago_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\YearInReviewClusterStrategy:
        arguments:
            $minItemsPerYear: 110
            $minDistinctMonths: 4
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.year_in_review_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\MonthlyHighlightsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerMonth: 28
            $minDistinctDays: 7
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.monthly_highlights_cluster_strategy%' }

    MagicSunday\Memories\Service\Clusterer\TitleGeneratorInterface:
        alias: MagicSunday\Memories\Service\Clusterer\SmartTitleGenerator

    MagicSunday\Memories\Service\Clusterer\HybridClusterer:
        arguments:
            $strategies: !tagged_iterator 'memories.cluster_strategy'

    MagicSunday\Memories\Service\Clusterer\ClusterPersistenceService: ~

    MagicSunday\Memories\Service\Clusterer\ClusterConsolidationService:
        arguments:
            $keepOrder: '%memories.cluster.consolidate.keep_order%'
            $overlapMergeThreshold: '%memories.cluster.consolidate.overlap_merge_threshold%'
            $overlapDropThreshold: '%memories.cluster.consolidate.overlap_drop_threshold%'
            $perMediaCap: '%memories.cluster.consolidate.per_media_cap%'
            $minScore: '%memories.cluster.consolidate.min_score%'
            $minSize: '%memories.cluster.consolidate.min_size%'
            $annotateOnly: '%memories.cluster.consolidate.annotate_only%'
            $minUniqueShare: '%memories.cluster.consolidate.min_unique_share%'
            $requireValidTime: '%memories.cluster.consolidate.require_valid_time%'
            $minValidYear: '%memories.cluster.consolidate.min_valid_year%'

    ########################################
    # Scoring
    ########################################

    MagicSunday\Memories\Service\Clusterer\Scoring\GermanHolidayResolver: ~

    MagicSunday\Memories\Service\Clusterer\Scoring\HolidayResolverInterface:
        alias: MagicSunday\Memories\Service\Clusterer\Scoring\GermanHolidayResolver

    MagicSunday\Memories\Service\Clusterer\Scoring\NoveltyHeuristic:
        arguments:
            $gridStepDeg: 0.5
            $phashPrefixNibbles: 4
            $weights:
                place: 0.35
                time: 0.25
                device: 0.20
                content: 0.20

    MagicSunday\Memories\Service\Clusterer\Scoring\CompositeClusterScorer:
        arguments:
            $weights:
                quality: 0.22
                aesthetics: 0.08
                people: 0.16
                content: 0.09
                density: 0.10
                novelty: 0.09
                holiday: 0.07
                recency: 0.12
                location: 0.05
                poi: 0.02
                time_coverage: 0.10
            $algorithmBoosts:
                vacation: 1.28
                transit_travel_day: 1.05
                camping_trip: 1.22
                significant_place: 1.05
                first_visit_place: 1.02
                location_similarity: 1.05
                person_cohort: 1.22
                holiday_event: 1.10
                new_year_eve: 1.12
                sports_event: 1.08
                festival_summer: 1.10
                nightlife_event: 1.05
                cityscape_night: 1.04
                hike_adventure: 1.15
                zoo_aquarium: 1.06
                kids_birthday_party: 1.25
                cross_dimension: 1.03
                on_this_day_over_years: 1.08
                one_year_ago: 1.12
                anniversary: 1.12
                weekend_getaways_over_years: 1.14
                beach_over_years: 1.08
                camping_over_years: 1.14
                snow_vacation_over_years: 1.12
                museum_over_years: 1.02
                zoo_aquarium_over_years: 1.05
                season_over_years: 1.02
                this_month_over_years: 1.02
                year_in_review: 1.15
                monthly_highlights: 1.06
                season: 0.95
                golden_hour: 1.02
                sunny_day: 0.95
                snow_day: 1.05
                rainy_day: 0.92
                day_album: 1.06
                dining_out: 1.02
                morning_coffee: 0.90
                time_similarity: 1.00
                pet_moments: 1.05
                photo_motif: 0.88
                panorama: 1.00
                panorama_over_years: 1.06
                portrait_orientation: 0.88
                video_stories: 0.94
                at_home_weekend: 0.96
                at_home_weekday: 0.92
                device_similarity: 0.82
                phash_similarity: 0.55
                burst: 0.55
            $poiCategoryBoosts: '%memories.score.poi_category_boosts%'
            $qualityBaselineMegapixels: 12.0
            $minValidYear: '%memories.score.min_valid_year%'
            $timeRangeMinSamples: '%memories.score.time_range.min_samples%'
            $timeRangeMinCoverage: '%memories.score.time_range.min_coverage%'

    ########################################
    # Feed
    ########################################

    MagicSunday\Memories\Service\Feed\CoverPickerInterface:
        alias: MagicSunday\Memories\Service\Feed\DefaultCoverPicker

    MagicSunday\Memories\Service\Feed\DefaultCoverPicker: ~

    MagicSunday\Memories\Repository\MediaRepository: ~
    MagicSunday\Memories\Repository\WeatherObservationRepository: ~

    MagicSunday\Memories\Service\Feed\MemoryFeedBuilder:
        arguments:
            $minScore: '%memories.feed.min_score%'
            $minMembers: '%memories.feed.min_members%'
            $maxPerDay: '%memories.feed.max_per_day%'
            $maxTotal: '%memories.feed.max_total%'
            $maxPerAlgorithm: '%memories.feed.max_per_algorithm%'

    MagicSunday\Memories\Service\Feed\FeedBuilderInterface:
        alias: MagicSunday\Memories\Service\Feed\MemoryFeedBuilder

    # Weather
    MagicSunday\Memories\Service\Weather\NullWeatherHintProvider: ~

    MagicSunday\Memories\Service\Weather\OpenWeatherHintProvider:
        arguments:
            $http: '@Symfony\Contracts\HttpClient\HttpClientInterface'
            $storage: '@MagicSunday\Memories\Service\Weather\WeatherObservationStorageInterface'
            $baseUrl: '%memories.weather.openweather.base_url%'
            $apiKey: '%memories.weather.openweather.api_key%'
            $maxPastHours: '%memories.weather.openweather.max_past_hours%'
            $source: '%memories.weather.openweather.source%'

    MagicSunday\Memories\Service\Weather\DoctrineWeatherObservationStorage: ~

    MagicSunday\Memories\Service\Weather\ToggleableWeatherHintProvider:
        arguments:
            $primary: '@MagicSunday\Memories\Service\Weather\OpenWeatherHintProvider'
            $fallback: '@MagicSunday\Memories\Service\Weather\NullWeatherHintProvider'
            $enabled: '%memories.weather.enabled%'

    MagicSunday\Memories\Service\Weather\WeatherHintProviderInterface:
        alias: MagicSunday\Memories\Service\Weather\ToggleableWeatherHintProvider

    MagicSunday\Memories\Service\Weather\WeatherObservationStorageInterface:
        alias: MagicSunday\Memories\Service\Weather\DoctrineWeatherObservationStorage

    # Feeds
    MagicSunday\Memories\Service\Feed\ThumbnailPathResolver: ~
    MagicSunday\Memories\Service\Feed\HtmlFeedRenderer: ~

    # Title
    MagicSunday\Memories\Service\Clusterer\Title\TitleTemplateProvider:
        arguments:
            $configPath: '%kernel.project_dir%/config/templates/titles.yaml'
            $locale: 'de'

    MagicSunday\Memories\Service\Clusterer\SmartTitleGenerator:
        arguments:
            $provider: '@MagicSunday\Memories\Service\Clusterer\Title\TitleTemplateProvider'

    # Support
    MagicSunday\Memories\Support\ClusterEntityToDraftMapper: ~
