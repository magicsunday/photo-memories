# config/services.yaml
imports:
    - { resource: 'parameters.yaml' }

services:
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.
        public: false

    # Makes classes in src/ available to be used as services.
    # This creates a service per class whose id is the fully qualified class name.
    MagicSunday\Memories\:
        resource: '../src/*'
        exclude:
            - '../src/{Memories,Dependencies}.php'
            - '../src/Entity/'

    _instanceof:
        Symfony\Component\Console\Command\Command:
            tags: ['command']

    MagicSunday\Memories\Application:
        public: true
        arguments:
            $commands: !tagged command

    MagicSunday\Memories\Utility\DefaultPoiContextAnalyzer:
        arguments:
            $preferredLocale: '%memories.localization.preferred_locale%'

    MagicSunday\Memories\Utility\Contract\PoiContextAnalyzerInterface:
        alias: MagicSunday\Memories\Utility\DefaultPoiContextAnalyzer

    MagicSunday\Memories\Utility\Contract\LocationLabelResolverInterface:
        alias: MagicSunday\Memories\Utility\DefaultLocationLabelResolver

    ########################################
    # Doctrine EntityManager (ORM 3.5+)
    ########################################
    MagicSunday\Memories\Doctrine\EntityManagerFactory: ~

    # Doctrine EntityManager service and alias for autowiring
    Doctrine\ORM\EntityManagerInterface:
        factory: ['@MagicSunday\Memories\Doctrine\EntityManagerFactory', 'create']
        public: true

    Doctrine\ORM\EntityManager:
        alias: Doctrine\ORM\EntityManagerInterface

    ########################################
    # Thumbnail Service
    ########################################
    MagicSunday\Memories\Service\Thumbnail\ThumbnailService:
        arguments:
            $thumbnailDir: '%env(string:MEMORIES_THUMBNAIL_DIR)%'
            $sizes: '%memories.thumbnail_sizes%'

    MagicSunday\Memories\Service\Thumbnail\ThumbnailServiceInterface:
        alias: MagicSunday\Memories\Service\Thumbnail\ThumbnailService

    ########################################
    # Metadata Extractors & Enricher
    ########################################
    MagicSunday\Memories\Service\Metadata\ExifMetadataExtractor:
        arguments:
            $readExifForVideos: false

    MagicSunday\Memories\Service\Metadata\XmpIptcExtractor: ~

    MagicSunday\Memories\Service\Metadata\FilenameKeywordExtractor: ~

    MagicSunday\Memories\Service\Metadata\AppleHeuristicsExtractor: ~

    MagicSunday\Memories\Service\Metadata\GeoFeatureEnricher:
        arguments:
            $homeLat: '%env(float:MEMORIES_HOME_LAT)%'
            $homeLon: '%env(float:MEMORIES_HOME_LON)%'
            $cellDegrees: 0.01

    MagicSunday\Memories\Service\Metadata\CalendarFeatureEnricher: ~

    MagicSunday\Memories\Service\Metadata\DaypartEnricher: ~

    MagicSunday\Memories\Service\Metadata\SolarEnricher:
        arguments:
            $goldenMinutes: 60

    MagicSunday\Memories\Service\Metadata\VisionSignatureExtractor:
        arguments:
            $sampleSize: 320

    MagicSunday\Memories\Service\Metadata\FfprobeMetadataExtractor:
        arguments:
            $ffprobePath: '%env(string:FFPROBE_PATH)%'
            $slowMoFpsThreshold: 100.0

    MagicSunday\Memories\Service\Metadata\PerceptualHashExtractor:
        arguments:
            $dctSampleSize: '%memories.hash.dct_sample%'
            $lowFreqSize: '%memories.hash.lowfreq%'

    MagicSunday\Memories\Service\Metadata\CompositeMetadataExtractor:
        arguments:
            $extractors:
                - '@MagicSunday\Memories\Service\Metadata\ExifMetadataExtractor'
                - '@MagicSunday\Memories\Service\Metadata\XmpIptcExtractor'
                - '@MagicSunday\Memories\Service\Metadata\FilenameKeywordExtractor'
                - '@MagicSunday\Memories\Service\Metadata\AppleHeuristicsExtractor'
                - '@MagicSunday\Memories\Service\Metadata\GeoFeatureEnricher'
                - '@MagicSunday\Memories\Service\Metadata\CalendarFeatureEnricher'
                - '@MagicSunday\Memories\Service\Metadata\DaypartEnricher'
                - '@MagicSunday\Memories\Service\Metadata\SolarEnricher'
                - '@MagicSunday\Memories\Service\Metadata\VisionSignatureExtractor'
                - '@MagicSunday\Memories\Service\Metadata\FfprobeMetadataExtractor'
                - '@MagicSunday\Memories\Service\Metadata\PerceptualHashExtractor'

    MagicSunday\Memories\Service\Metadata\MetadataExtractorInterface:
        alias: MagicSunday\Memories\Service\Metadata\CompositeMetadataExtractor

    ########################################
    # Indexing
    ########################################

    MagicSunday\Memories\Service\Indexing\DefaultMediaFileLocator:
        arguments:
            $imageExtensions: '%memories.index.image_ext%'
            $videoExtensions: '%memories.index.video_ext%'

    MagicSunday\Memories\Service\Indexing\MediaFileLocatorInterface:
        alias: MagicSunday\Memories\Service\Indexing\DefaultMediaFileLocator

    MagicSunday\Memories\Service\Indexing\DefaultMediaIngestionPipeline:
        arguments:
            $imageExtensions: '%memories.index.image_ext%'
            $videoExtensions: '%memories.index.video_ext%'

    MagicSunday\Memories\Service\Indexing\MediaIngestionPipelineInterface:
        alias: MagicSunday\Memories\Service\Indexing\DefaultMediaIngestionPipeline

    ########################################
    # Geocoding
    ########################################

    # Einfach: Interface direkt per Factory bereitstellen (kein 'http_client' Alias n√∂tig)
    Symfony\Contracts\HttpClient\HttpClientInterface:
        factory: ['Symfony\Component\HttpClient\HttpClient', 'create']
        arguments:
            - {
                headers: {
                    'User-Agent': '%memories.geocoding.nominatim.user_agent% (%memories.geocoding.nominatim.email%)',
                    'Accept': 'application/json'
                },
              # optional: Timeout/Verify/Base-URI etc.
                max_redirects: 5,
                timeout: 10.0
            }

    MagicSunday\Memories\Service\Geocoding\NominatimReverseGeocoder:
        arguments:
            $http: '@Symfony\Contracts\HttpClient\HttpClientInterface'
            $baseUrl: '%memories.geocoding.nominatim.base_url%'
            $userAgent: '%memories.geocoding.nominatim.user_agent%'
            $contactEmail: '%memories.geocoding.nominatim.email%'
            $zoom: '%memories.geocoding.nominatim.zoom%'

    MagicSunday\Memories\Service\Geocoding\ReverseGeocoderInterface:
        alias: MagicSunday\Memories\Service\Geocoding\NominatimReverseGeocoder

    MagicSunday\Memories\Service\Geocoding\OverpassClient:
        arguments:
            $http: '@Symfony\Contracts\HttpClient\HttpClientInterface'
            $baseUrl: '%memories.geocoding.overpass.base_url%'
            $userAgent: '%memories.geocoding.nominatim.user_agent%'
            $contactEmail: '%memories.geocoding.nominatim.email%'
            $httpTimeout: '%memories.geocoding.overpass.timeout%'

    MagicSunday\Memories\Service\Geocoding\OverpassTagConfiguration:
        arguments:
            $additionalAllowedTags: '%memories.geocoding.overpass.allowed_pois%'

    MagicSunday\Memories\Service\Geocoding\DefaultOverpassQueryBuilder:
        arguments:
            $queryTimeout: '%memories.geocoding.overpass.timeout%'

    MagicSunday\Memories\Service\Geocoding\OverpassQueryBuilderInterface:
        alias: MagicSunday\Memories\Service\Geocoding\DefaultOverpassQueryBuilder

    MagicSunday\Memories\Service\Geocoding\DefaultOverpassResponseParser: ~

    MagicSunday\Memories\Service\Geocoding\OverpassResponseParserInterface:
        alias: MagicSunday\Memories\Service\Geocoding\DefaultOverpassResponseParser

    MagicSunday\Memories\Service\Geocoding\LocationPoiEnricher:
        arguments:
            $radiusMeters: '%memories.geocoding.overpass.radius_m%'
            $maxPois: '%memories.geocoding.overpass.max_pois%'
            $fetchLimitMultiplier: '%memories.geocoding.overpass.fetch_limit_multiplier%'

    MagicSunday\Memories\Service\Geocoding\LocationCellIndex: ~

    MagicSunday\Memories\Service\Geocoding\LocationResolver:
        arguments:
            $cellDeg: 0.01
            $poiEnricher: '@MagicSunday\Memories\Service\Geocoding\LocationPoiEnricher'

    MagicSunday\Memories\Service\Geocoding\MediaLocationLinker:
        arguments:
            $cellDeg: 0.01

    MagicSunday\Memories\Service\Geocoding\MediaLocationLinkerInterface:
        alias: MagicSunday\Memories\Service\Geocoding\MediaLocationLinker

    MagicSunday\Memories\Service\Geocoding\DefaultMediaGeocodingProcessor:
        arguments:
            $locale: '%memories.localization.preferred_locale%'
            $delayMs: '%memories.geocoding.delay_ms%'

    MagicSunday\Memories\Service\Geocoding\MediaGeocodingProcessorInterface:
        alias: MagicSunday\Memories\Service\Geocoding\DefaultMediaGeocodingProcessor

    MagicSunday\Memories\Service\Geocoding\PoiUpdateProcessorInterface:
        alias: MagicSunday\Memories\Service\Geocoding\DefaultPoiUpdateProcessor

    MagicSunday\Memories\Service\Geocoding\PoiEnsurerInterface:
        alias: MagicSunday\Memories\Service\Geocoding\LocationResolver


    ########################################
    # Clustering
    ########################################

    MagicSunday\Memories\Clusterer\TimeSimilarityStrategy:
        arguments:
            $maxGapSeconds: 10800   # 3h keeps sessions cohesive without spanning full days
            $minItemsPerBucket: 9
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.time_similarity_strategy%' }

    MagicSunday\Memories\Clusterer\LocationSimilarityStrategy:
        arguments:
            $radiusMeters: 140.0
            $minItemsPerPlace: 6
            $maxSpanHours: 16
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.location_similarity_strategy%' }

    MagicSunday\Memories\Clusterer\DeviceSimilarityStrategy:
        arguments:
            $minItemsPerGroup: 5
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.device_similarity_strategy%' }

    MagicSunday\Memories\Clusterer\PhashSimilarityStrategy:
        arguments:
            $maxHamming: 7
            $minItemsPerBucket: 2
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.phash_similarity_strategy%' }

    # --- Composition & session heuristics ---
    MagicSunday\Memories\Clusterer\BurstClusterStrategy:
        arguments:
            $maxGapSeconds: 90
            $maxMoveMeters: 45.0
            $minItemsPerBurst: 3
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.burst_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\CrossDimensionClusterStrategy:
        arguments:
            $timeGapSeconds: 5400        # 1.5h blends adjacent scene
            $radiusMeters: 130.0
            $minItemsPerRun: 5
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.cross_dimension_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PanoramaClusterStrategy:
        arguments:
            $minAspect: 2.3
            $sessionGapSeconds: 9000   # 2.5h
            $minItemsPerRun: 3
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.panorama_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PanoramaOverYearsClusterStrategy:
        arguments:
            $minAspect: 2.3
            $minItemsPerYear: 2
            $minYears: 3
            $minItemsTotal: 10
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.panorama_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PortraitOrientationClusterStrategy:
        arguments:
            $minPortraitRatio: 1.2
            $sessionGapSeconds: 7200      # 2h
            $minItemsPerRun: 4
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.portrait_orientation_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\VideoStoriesClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 2
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.video_stories_cluster_strategy%' }

    # --- Daily life & home rituals ---
    MagicSunday\Memories\Clusterer\DayAlbumClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 7
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.day_album_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\AtHomeWeekendClusterStrategy:
        arguments:
            $homeLat: '%env(float:MEMORIES_HOME_LAT)%'
            $homeLon: '%env(float:MEMORIES_HOME_LON)%'
            $homeRadiusMeters: 260.0
            $minHomeShare: 0.62
            $minItemsPerDay: 3
            $minItemsTotal: 6
            $timezone: 'Europe/Berlin'
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.at_home_weekend_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\AtHomeWeekdayClusterStrategy:
        arguments:
            $homeLat: '%env(float:MEMORIES_HOME_LAT)%'
            $homeLon: '%env(float:MEMORIES_HOME_LON)%'
            $homeRadiusMeters: 250.0
            $minHomeShare: 0.60
            $minItemsPerDay: 3
            $minItemsTotal: 5
            $timezone: 'Europe/Berlin'
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.at_home_weekday_cluster_strategy%' }

    # --- Social celebrations & people ---
    MagicSunday\Memories\Clusterer\AnniversaryClusterStrategy:
        arguments:
            $minItemsPerAnniversary: 5
            $minDistinctYears: 10
            $maxClusters: 30
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.anniversary_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\PersonCohortClusterStrategy:
        arguments:
            $minPersons: 2
            $minItemsTotal: 4
            $windowDays: 10
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.person_cohort_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\HolidayEventClusterStrategy:
        arguments:
            $minItemsPerHoliday: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.holiday_event_cluster_strategy%' }

    # --- Special outings & events ---
    MagicSunday\Memories\Clusterer\NightlifeEventClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $timeGapSeconds: 9000        # 2.5h keeps multi-venue nights linked
            $radiusMeters: 260.0
            $minItemsPerRun: 5
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.nightlife_event_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\NewYearEveClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $startHour: 20
            $endHour: 2
            $minItemsPerYear: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.new_year_eve_cluster_strategy%' }

    # --- Travel & outdoor adventures ---
    MagicSunday\Memories\Clusterer\DefaultHomeLocator:
        arguments:
            $timezone: 'Europe/Berlin'
            $defaultHomeRadiusKm: 15.0
            $homeLat: '%env(default::float:MEMORIES_HOME_LAT)%'
            $homeLon: '%env(default::float:MEMORIES_HOME_LON)%'
            $homeRadiusKm: '%env(default::float:MEMORIES_HOME_RADIUS_KM)%'

    MagicSunday\Memories\Clusterer\Contract\HomeLocatorInterface:
        alias: MagicSunday\Memories\Clusterer\DefaultHomeLocator

    MagicSunday\Memories\Clusterer\Service\StaypointDetector: ~

    MagicSunday\Memories\Clusterer\Contract\StaypointDetectorInterface:
        alias: MagicSunday\Memories\Clusterer\Service\StaypointDetector

    MagicSunday\Memories\Clusterer\Service\BaseLocationResolver: ~

    MagicSunday\Memories\Clusterer\Contract\BaseLocationResolverInterface:
        alias: MagicSunday\Memories\Clusterer\Service\BaseLocationResolver

    MagicSunday\Memories\Clusterer\Service\TimezoneResolver:
        arguments:
            $timezone: 'Europe/Berlin'

    MagicSunday\Memories\Clusterer\Contract\TimezoneResolverInterface:
        alias: MagicSunday\Memories\Clusterer\Service\TimezoneResolver

    MagicSunday\Memories\Clusterer\Service\PoiClassifier: ~

    MagicSunday\Memories\Clusterer\Contract\PoiClassifierInterface:
        alias: MagicSunday\Memories\Clusterer\Service\PoiClassifier

    MagicSunday\Memories\Clusterer\DefaultDaySummaryBuilder:
        arguments:
            $timezone: 'Europe/Berlin'
            $gpsOutlierRadiusKm: 1.0
            $gpsOutlierMinSamples: 3
            $minItemsPerDay: 3

    MagicSunday\Memories\Clusterer\Contract\DaySummaryBuilderInterface:
        alias: MagicSunday\Memories\Clusterer\DefaultDaySummaryBuilder

    MagicSunday\Memories\Clusterer\Service\TransportDayExtender: ~

    MagicSunday\Memories\Clusterer\Service\RunDetector:
        arguments:
            $minAwayDistanceKm: 120.0
            $minItemsPerDay: 3

    MagicSunday\Memories\Clusterer\Contract\VacationRunDetectorInterface:
        alias: MagicSunday\Memories\Clusterer\Service\RunDetector

    MagicSunday\Memories\Clusterer\Service\VacationScoreCalculator:
        arguments:
            $timezone: 'Europe/Berlin'
            $movementThresholdKm: 35.0

    MagicSunday\Memories\Clusterer\Contract\VacationScoreCalculatorInterface:
        alias: MagicSunday\Memories\Clusterer\Service\VacationScoreCalculator

    MagicSunday\Memories\Clusterer\DefaultVacationSegmentAssembler: ~

    MagicSunday\Memories\Clusterer\Contract\VacationSegmentAssemblerInterface:
        alias: MagicSunday\Memories\Clusterer\DefaultVacationSegmentAssembler

    MagicSunday\Memories\Clusterer\VacationClusterStrategy:
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.vacation_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\WeekendGetawaysOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minNights: 1
            $maxNights: 3
            $minItemsPerDay: 4
            $minYears: 3
            $minItemsTotal: 20
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.weekend_getaways_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\TransitTravelDayClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minTravelKm: 70.0
            $minItemsPerDay: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.transit_travel_day_cluster_strategy%' }

    # --- Place-based explorations ---
    MagicSunday\Memories\Clusterer\FirstVisitPlaceClusterStrategy:
        arguments:
            $gridDegrees: 0.01
            $timezone: 'Europe/Berlin'
            $minItemsPerDay: 4
            $minNights: 0
            $maxNights: 3
            $minItemsTotal: 7
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.first_visit_place_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\SignificantPlaceClusterStrategy:
        arguments:
            $gridDegrees: 0.01
            $minVisitDays: 3
            $minItemsTotal: 16
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.significant_place_cluster_strategy%' }

    # --- Seasonal highlights ---
    MagicSunday\Memories\Clusterer\SeasonClusterStrategy:
        arguments:
            $minItemsPerSeason: 18
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.season_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\SeasonOverYearsClusterStrategy:
        arguments:
            $minYears: 3
            $minItemsPerSeason: 26
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.season_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\GoldenHourClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $morningHours:
                - 6
                - 7
                - 8
            $eveningHours:
                - 18
                - 19
                - 20
            $sessionGapSeconds: 5400
            $minItemsPerRun: 4
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.golden_hour_cluster_strategy%' }

    # --- Temporal retrospectives ---
    MagicSunday\Memories\Clusterer\ThisMonthOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minYears: 3
            $minItemsTotal: 20
            $minDistinctDays: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.this_month_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\OnThisDayOverYearsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $windowDays: 0
            $minYears: 3
            $minItemsTotal: 10
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.on_this_day_over_years_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\OneYearAgoClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $windowDays: 3
            $minItemsTotal: 6
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.one_year_ago_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\YearInReviewClusterStrategy:
        arguments:
            $minItemsPerYear: 110
            $minDistinctMonths: 4
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.year_in_review_cluster_strategy%' }

    MagicSunday\Memories\Clusterer\MonthlyHighlightsClusterStrategy:
        arguments:
            $timezone: 'Europe/Berlin'
            $minItemsPerMonth: 28
            $minDistinctDays: 7
        tags:
            - { name: 'memories.cluster_strategy', priority: '%memories.cluster.priority.monthly_highlights_cluster_strategy%' }

    MagicSunday\Memories\Service\Clusterer\TitleGeneratorInterface:
        alias: MagicSunday\Memories\Service\Clusterer\SmartTitleGenerator

    MagicSunday\Memories\Service\Clusterer\HybridClusterer:
        arguments:
            $strategies: !tagged_iterator 'memories.cluster_strategy'

    MagicSunday\Memories\Service\Clusterer\ClusterPersistenceService: ~

    MagicSunday\Memories\Service\Clusterer\Pipeline\FilterNormalizationStage:
        arguments:
            $minScore: '%memories.cluster.consolidate.min_score%'
            $minSize: '%memories.cluster.consolidate.min_size%'
            $requireValidTime: '%memories.cluster.consolidate.require_valid_time%'
            $minValidYear: '%memories.cluster.consolidate.min_valid_year%'
        tags:
            - { name: 'memories.cluster_consolidation.stage', priority: 500 }

    MagicSunday\Memories\Service\Clusterer\Pipeline\DuplicateCollapseStage:
        arguments:
            $keepOrder: '%memories.cluster.consolidate.keep_order%'
        tags:
            - { name: 'memories.cluster_consolidation.stage', priority: 400 }

    MagicSunday\Memories\Service\Clusterer\Pipeline\DominanceSelectionStage:
        arguments:
            $overlapMergeThreshold: '%memories.cluster.consolidate.overlap_merge_threshold%'
            $overlapDropThreshold: '%memories.cluster.consolidate.overlap_drop_threshold%'
            $keepOrder: '%memories.cluster.consolidate.keep_order%'
        tags:
            - { name: 'memories.cluster_consolidation.stage', priority: 300 }

    MagicSunday\Memories\Service\Clusterer\Pipeline\AnnotationPruningStage:
        arguments:
            $annotateOnly: '%memories.cluster.consolidate.annotate_only%'
            $minUniqueShare: '%memories.cluster.consolidate.min_unique_share%'
        tags:
            - { name: 'memories.cluster_consolidation.stage', priority: 200 }

    MagicSunday\Memories\Service\Clusterer\Pipeline\PerMediaCapStage:
        arguments:
            $perMediaCap: '%memories.cluster.consolidate.per_media_cap%'
            $keepOrder: '%memories.cluster.consolidate.keep_order%'
            $algorithmGroups: '%memories.cluster.consolidate.groups%'
            $defaultAlgorithmGroup: '%memories.cluster.consolidate.default_group%'
        tags:
            - { name: 'memories.cluster_consolidation.stage', priority: 100 }

    MagicSunday\Memories\Service\Clusterer\Pipeline\PipelineClusterConsolidator:
        arguments:
            $stages: !tagged_iterator 'memories.cluster_consolidation.stage'

    MagicSunday\Memories\Service\Clusterer\Contract\ClusterConsolidatorInterface:
        alias: MagicSunday\Memories\Service\Clusterer\Pipeline\PipelineClusterConsolidator

    MagicSunday\Memories\Service\Clusterer\ClusterConsolidationService:
        alias: MagicSunday\Memories\Service\Clusterer\Pipeline\PipelineClusterConsolidator

    ########################################
    # Scoring
    ########################################

    MagicSunday\Memories\Service\Clusterer\Scoring\GermanHolidayResolver: ~

    MagicSunday\Memories\Service\Clusterer\Scoring\HolidayResolverInterface:
        alias: MagicSunday\Memories\Service\Clusterer\Scoring\GermanHolidayResolver

    MagicSunday\Memories\Service\Clusterer\Scoring\NoveltyHeuristic:
        arguments:
            $gridStepDeg: 0.5
            $phashPrefixNibbles: 4
            $weights:
                place: 0.35
                time: 0.25
                device: 0.20
                content: 0.20

    MagicSunday\Memories\Service\Clusterer\Scoring\TemporalClusterScoreHeuristic:
        arguments:
            $timeRangeMinSamples: '%memories.score.time_range.min_samples%'
            $timeRangeMinCoverage: '%memories.score.time_range.min_coverage%'
            $minValidYear: '%memories.score.min_valid_year%'

    MagicSunday\Memories\Service\Clusterer\Scoring\QualityClusterScoreHeuristic:
        arguments:
            $qualityBaselineMegapixels: 12.0

    MagicSunday\Memories\Service\Clusterer\Scoring\PeopleClusterScoreHeuristic: ~

    MagicSunday\Memories\Service\Clusterer\Scoring\ContentClusterScoreHeuristic: ~

    MagicSunday\Memories\Service\Clusterer\Scoring\LocationClusterScoreHeuristic: ~

    MagicSunday\Memories\Service\Clusterer\Scoring\PoiClusterScoreHeuristic:
        arguments:
            $poiCategoryBoosts: '%memories.score.poi_category_boosts%'

    MagicSunday\Memories\Service\Clusterer\Scoring\HolidayClusterScoreHeuristic:
        arguments:
            $timeRangeMinSamples: '%memories.score.time_range.min_samples%'
            $timeRangeMinCoverage: '%memories.score.time_range.min_coverage%'
            $minValidYear: '%memories.score.min_valid_year%'

    MagicSunday\Memories\Service\Clusterer\Scoring\RecencyClusterScoreHeuristic:
        arguments:
            $timeRangeMinSamples: '%memories.score.time_range.min_samples%'
            $timeRangeMinCoverage: '%memories.score.time_range.min_coverage%'
            $minValidYear: '%memories.score.min_valid_year%'

    MagicSunday\Memories\Service\Clusterer\Scoring\DensityClusterScoreHeuristic:
        arguments:
            $timeRangeMinSamples: '%memories.score.time_range.min_samples%'
            $timeRangeMinCoverage: '%memories.score.time_range.min_coverage%'
            $minValidYear: '%memories.score.min_valid_year%'

    MagicSunday\Memories\Service\Clusterer\Scoring\CompositeClusterScorer:
        arguments:
            $heuristics:
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\TemporalClusterScoreHeuristic'
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\QualityClusterScoreHeuristic'
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\PeopleClusterScoreHeuristic'
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\ContentClusterScoreHeuristic'
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\LocationClusterScoreHeuristic'
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\PoiClusterScoreHeuristic'
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\NoveltyHeuristic'
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\HolidayClusterScoreHeuristic'
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\RecencyClusterScoreHeuristic'
                - '@MagicSunday\Memories\Service\Clusterer\Scoring\DensityClusterScoreHeuristic'
            $weights:
                quality: 0.22
                aesthetics: 0.08
                people: 0.16
                content: 0.09
                density: 0.10
                novelty: 0.09
                holiday: 0.07
                recency: 0.12
                location: 0.05
                poi: 0.02
                time_coverage: 0.10
            $algorithmBoosts:
                vacation: 1.45
                transit_travel_day: 0.95
                significant_place: 0.98
                first_visit_place: 0.97
                location_similarity: 0.96
                person_cohort: 1.22
                holiday_event: 1.26
                new_year_eve: 1.27
                nightlife_event: 1.05
                cityscape_night: 1.04
                hike_adventure: 1.30
                cross_dimension: 1.03
                on_this_day_over_years: 1.22
                one_year_ago: 1.24
                anniversary: 1.30
                weekend_getaways_over_years: 1.26
                snow_vacation_over_years: 1.25
                season_over_years: 1.05
                this_month_over_years: 1.08
                year_in_review: 1.25
                monthly_highlights: 1.15
                season: 0.95
                golden_hour: 1.00
                snow_day: 1.00
                day_album: 0.98
                time_similarity: 0.94
                photo_motif: 0.88
                panorama: 0.95
                panorama_over_years: 1.00
                portrait_orientation: 0.88
                video_stories: 0.94
                at_home_weekend: 0.90
                at_home_weekday: 0.88
                device_similarity: 0.82
                phash_similarity: 0.55
                burst: 0.55
            $algorithmGroups: '%memories.cluster.consolidate.groups%'

    ########################################
    # Feed
    ########################################

    MagicSunday\Memories\Service\Feed\CoverPickerInterface:
        alias: MagicSunday\Memories\Service\Feed\DefaultCoverPicker

    MagicSunday\Memories\Service\Feed\DefaultCoverPicker: ~

    MagicSunday\Memories\Repository\MediaRepository: ~

    MagicSunday\Memories\Service\Feed\MemoryFeedBuilder:
        arguments:
            $minScore: '%memories.feed.min_score%'
            $minMembers: '%memories.feed.min_members%'
            $maxPerDay: '%memories.feed.max_per_day%'
            $maxTotal: '%memories.feed.max_total%'
            $maxPerAlgorithm: '%memories.feed.max_per_algorithm%'

    MagicSunday\Memories\Service\Feed\FeedBuilderInterface:
        alias: MagicSunday\Memories\Service\Feed\MemoryFeedBuilder

    # Feeds
    MagicSunday\Memories\Service\Feed\ThumbnailPathResolver: ~
    MagicSunday\Memories\Service\Feed\HtmlFeedRenderer: ~

    # Title
    MagicSunday\Memories\Service\Clusterer\Title\TitleTemplateProvider:
        arguments:
            $configPath: '%kernel.project_dir%/config/templates/titles.yaml'
            $locale: 'de'

    MagicSunday\Memories\Service\Clusterer\SmartTitleGenerator:
        arguments:
            $provider: '@MagicSunday\Memories\Service\Clusterer\Title\TitleTemplateProvider'

    # Support
    MagicSunday\Memories\Support\ClusterEntityToDraftMapper:
        arguments:
            $algorithmGroups: '%memories.cluster.consolidate.groups%'
