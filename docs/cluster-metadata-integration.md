# Nutzung der Metadaten in den Cluster-Strategien

## Bestandsaufnahme der vorhandenen Metadaten
Die `Media`-Entität persistiert weit mehr als nur Zeit- und GPS-Informationen. Neben Aufnahmezeit und -ort stehen Gerätemerkmale (Kamera, Objektiv, Seriennummern), Qualitätsmetriken (Schärfe, ISO, Belichtung), Szenenklassifizierungen, Schlagwörter sowie Gesichts- und Personenlisten zur Verfügung.【F:src/Entity/Media.php†L200-L320】【F:src/Entity/Media.php†L400-L520】【F:src/Entity/Media.php†L2145-L2300】 Ergänzend liefern verknüpfte `Location`-Objekte strukturierte Adress- und POI-Informationen, die bereits normalisiert in der Datenbank vorliegen.【F:src/Entity/Location.php†L17-L146】

## Aktuelle Nutzung pro Strategie

Die folgende Übersicht fasst zusammen, welche Metadaten bereits produktiv zum Einsatz kommen und wo zusätzlicher Nutzen gehoben werden kann. Damit lassen sich Aufwände präzise planen und Verantwortlichkeiten an die betroffenen Quellmodule koppeln.

| Strategie | Bereits genutzte Metadaten | Potenzial / fehlende Nutzung |
| --- | --- | --- |
| **TimeSimilarityStrategy** | Aufnahmezeit (inkl. lokaler Tagesgrenzen), Ortslabels, dominante Schlagwörter/Szenentags, Qualitäts- und Personenmetriken.【F:src/Clusterer/TimeSimilarityStrategy.php†L55-L138】 | ✅ Score-Gewichte für Quality, People und Recency werden über `memories.cluster.scoring.weight_overrides` feinjustiert und vom `CompositeClusterScorer` pro Cluster angewendet.【F:config/parameters.yaml†L195-L240】【F:src/Service/Clusterer/Scoring/CompositeClusterScorer.php†L40-L264】 |
| **BurstClusterStrategy** | Zeit- & Ortskontext, Burst-IDs/-Repräsentanten, dominante Tags sowie aggregierte Personenmetriken.【F:src/Clusterer/BurstClusterStrategy.php†L69-L176】 | ✅ Personen- und Ortsparameter werden direkt beim Draft gesetzt. |
| **DeviceSimilarityStrategy** | Gerätedaten (Kamera/Lens/Owner), Content-Klassifizierung, Tagesbuckets sowie Tags, Personen- und Qualitätsmetriken.【F:src/Clusterer/DeviceSimilarityStrategy.php†L60-L238】 | ✅ Qualitätsmetriken (`quality_*`, `aesthetics_score`) werden nun direkt beim Draft hinterlegt und stehen Scoring-Heuristiken ohne Zusatzberechnung zur Verfügung. |
| **PortraitOrientationClusterStrategy** | Zeitfilter, Hochkantflag, Gesichtsanwesenheit, Orts- und Tag-Anreicherung, Personenmetriken.【F:src/Clusterer/PortraitOrientationClusterStrategy.php†L58-L159】 | ✅ `ClusterQualityAggregator` ergänzt nun `quality_*`- und `aesthetics_score`-Werte direkt im Draft.【F:src/Clusterer/PortraitOrientationClusterStrategy.php†L33-L167】 |
| **TransitTravelDayClusterStrategy** | GPS-Tagespfade, Distanz, Ortslabel, Away-Metriken sowie Geschwindigkeits- und Heading-Analyse.【F:src/Clusterer/TransitTravelDayClusterStrategy.php†L31-L226】 | ✅ Profilabhängige Schwellen (z. B. `adventurer`) werden über `memories.cluster.transit.threshold_profiles` gewählt und im Draft als `travel_profile` sowie `travel_thresholds` protokolliert.【F:config/parameters.yaml†L179-L194】【F:src/Clusterer/TransitTravelDayClusterStrategy.php†L41-L349】 |
| **MonthlyHighlightsClusterStrategy** | Monatsbuckets, dominante Tags, Ortscluster, Qualitäts- und Personenaggregation.【F:src/Clusterer/MonthlyHighlightsClusterStrategy.php†L42-L149】 | ✅ `ClusterDeviceMetadataAggregator` liefert jetzt `device_*`-Parameter inklusive Primärlabel und Anteil.【F:src/Clusterer/MonthlyHighlightsClusterStrategy.php†L38-L162】 |
| **NightlifeEventClusterStrategy** | Tageszeit/Daypart, POI-Kontext, Tags, Ortslabel, Personen- und Qualitätsmetriken.【F:src/Clusterer/NightlifeEventClusterStrategy.php†L33-L248】 | ✅ Gewichtung für Quality/Aesthetics wird über die globalen Override-Profile gesteuert.【F:config/parameters.yaml†L204-L207】【F:src/Service/Clusterer/Scoring/CompositeClusterScorer.php†L40-L264】 |
| **PersonCohortClusterStrategy** | Personenlisten, Kohortenbildung, Orts- und Schlagwortanreicherung sowie Personenmetriken.【F:src/Clusterer/PersonCohortClusterStrategy.php†L35-L214】 | ✅ Drafts enthalten das Qualitätsprofil `group_portrait` inklusive aggregierter `quality_*`-Parameter aus dem `ClusterQualityAggregator`.【F:src/Clusterer/PersonCohortClusterStrategy.php†L49-L249】 |
| **GoldenHourClusterStrategy** | Golden-Hour-Feature, lokale Zeitfenster, Szenentags, Keywords, Qualitäts- und Personenmetriken sowie Ortskomponenten.【F:src/Clusterer/GoldenHourClusterStrategy.php†L17-L191】 | ✅ Qualitätsgewichte erhalten über `memories.cluster.scoring.weight_overrides` einen dedizierten Boost.【F:config/parameters.yaml†L211-L214】【F:src/Service/Clusterer/Scoring/CompositeClusterScorer.php†L40-L264】 |
| **SignificantPlaceClusterStrategy** | Geogrid, Besuchstage, Orts- und POI-Label plus Szenentags/Keywords und Personenmetriken.【F:src/Clusterer/SignificantPlaceClusterStrategy.php†L17-L189】 | ✅ `ClusterQualityAggregator` schreibt nun `quality_*`-Kennzahlen in die Orts-Cluster.【F:src/Clusterer/SignificantPlaceClusterStrategy.php†L38-L179】 |
| **VideoStoriesClusterStrategy** | Videoflag, Dauer, SlowMo/Stabilisierung, Tags, Ortsmetadata, Qualitäts- und Personenmetriken.【F:src/Clusterer/VideoStoriesClusterStrategy.php†L17-L210】 | ✅ Gerätespezifische Aufnahmedetails (Gerätename, Anteil, Varianten, Lens) werden direkt als Draft-Parameter abgelegt.【F:src/Clusterer/VideoStoriesClusterStrategy.php†L126-L172】【F:src/Clusterer/Support/ClusterDeviceMetadataAggregator.php†L17-L184】 |
| **Zeit- & Feiertagsstrategien** (`HolidayEvent`, `Anniversary`, `Season`, `OnThisDay`, …) | Aufnahmezeiten, Kalenderfeatures, Orts- und POI-Daten sowie Qualitäts- und Personenmetriken.【F:src/Clusterer/HolidayEventClusterStrategy.php†L33-L170】【F:src/Clusterer/AnniversaryClusterStrategy.php†L29-L182】【F:src/Clusterer/SeasonClusterStrategy.php†L27-L131】【F:src/Clusterer/OnThisDayOverYearsClusterStrategy.php†L27-L146】 | ✅ Gewichtungsmatrizen für `holiday`, `quality` und `recency` sind zentral konfigurierbar und werden beim Scoring automatisch berücksichtigt.【F:config/parameters.yaml†L218-L240】【F:src/Service/Clusterer/Scoring/CompositeClusterScorer.php†L40-L264】 |

## Aufgabenplan zur besseren Metadatennutzung

Die folgenden Arbeitspakete zeigen, welche Anpassungen nötig sind, um den Nutzen der vorhandenen Metadaten vollständig auszuschöpfen. Jede Aufgabe verweist auf die betroffenen Quellmodule.

### Paket A – Personenmetriken konsequent erheben
- [x] **Gemeinsame Personenaggregation implementieren:** Der `ClusterPeopleAggregator` steht zur Verfügung und wird in zahlreichen Strategien (u. a. `Burst`, `DeviceSimilarity`, `MonthlyHighlights`, `PortraitOrientation`, `Nightlife`, `TimeSimilarity`, `HolidayEvent`, `Season*`) eingesetzt, um `people_*`-Parameter direkt beim Draft zu setzen.【F:src/Clusterer/Support/ClusterBuildHelperTrait.php†L57-L252】【F:src/Clusterer/BurstClusterStrategy.php†L148-L165】【F:src/Clusterer/TimeSimilarityStrategy.php†L116-L138】
- [x] **PersonCohort-Cluster beschreiben:** Nach Erstellung des Drafts `collectDominantTags()` und `applyLocationMetadata()` aus dem Helper/Trait aufrufen, damit die Cohort-Cluster neben Personen auch Orts- und Schlagwortinformationen enthalten.【F:src/Clusterer/PersonCohortClusterStrategy.php†L138-L214】【F:src/Clusterer/Support/ClusterLocationMetadataTrait.php†L27-L83】

### Paket B – Inhalts- und Kontextdaten ergänzen
- [x] **DayAlbum-Cluster anreichern:** Der Tagesalbum-Algorithmus setzt nun zusätzlich Personen- und Ortsparameter sowie Qualitätsmetriken direkt im Draft, wodurch Scoring und Feed-Beschreibung ohne Persistenz-Lookups auf Metadaten zugreifen können.【F:src/Clusterer/DayAlbumClusterStrategy.php†L21-L98】
- [x] **Portrait-Cluster anreichern:** In `PortraitOrientationClusterStrategy` nach dem Zeit-Bucketing `collectDominantTags()` nutzen und die Ortsanreicherung aus `ClusterLocationMetadataTrait` übernehmen, damit Porträtserien mit Schlagworten, Szenen und Ortskomponenten beschrieben werden.【F:src/Clusterer/PortraitOrientationClusterStrategy.php†L136-L147】【F:src/Clusterer/Support/ClusterLocationMetadataTrait.php†L27-L83】
- [x] **Device-Cluster mit Inhaltskontext erweitern:** `DeviceSimilarityStrategy` soll zusätzlich `collectDominantTags()` und den neuen Personenaggregator einsetzen, um wiederkehrende Motive des Geräts sichtbar zu machen. Bei neu eingeführten Parametern sicherstellen, dass `ClusterPersistenceService::buildMetadata()` sie übernimmt oder bewusst ignoriert.【F:src/Clusterer/DeviceSimilarityStrategy.php†L99-L124】【F:src/Service/Clusterer/ClusterPersistenceService.php†L264-L305】
- [x] **Nightlife- und Saison-Cluster erweitern:** Für `HolidayEvent` und alle Saison-/Jahres-Retrospektiven werden Qualitäts- und Personenmetriken inzwischen gesetzt.【F:src/Clusterer/HolidayEventClusterStrategy.php†L118-L170】【F:src/Clusterer/SeasonClusterStrategy.php†L91-L131】【F:src/Clusterer/SeasonOverYearsClusterStrategy.php†L75-L134】【F:src/Clusterer/YearInReviewClusterStrategy.php†L76-L137】【F:src/Clusterer/OnThisDayOverYearsClusterStrategy.php†L78-L146】【F:src/Clusterer/ThisMonthOverYearsClusterStrategy.php†L75-L146】【F:src/Clusterer/OneYearAgoClusterStrategy.php†L71-L146】 Der Nightlife-Cluster ergänzt nun ebenfalls Qualitäts- und Ortsparameter direkt beim Draft.【F:src/Clusterer/NightlifeEventClusterStrategy.php†L33-L248】 |

### Paket C – Bewegungs- und Qualitätsmetriken einbeziehen
- [x] **Reise-Cluster mit Bewegungsmetriken absichern:** In `TransitTravelDayClusterStrategy` zusätzlich die vorhandenen GPS-Geschwindigkeiten und Heading-Werte aus `Media` nutzen, um Tage mit überwiegender Fortbewegung robuster zu erkennen (z. B. Mindestanzahl schneller Segmente) und diese Werte in den Clusterparametern abzulegen.【F:src/Clusterer/TransitTravelDayClusterStrategy.php†L55-L226】【F:src/Entity/Media.php†L282-L303】
- [x] **Monatshighlights um Qualitätswerte erweitern:** Nach Auswahl der Monatsliste den Qualitätsaggregator (`ClusterQualityAggregator`) sowie den Personenaggregator einsetzen, um `quality_*`- und `people_*`-Parameter direkt im Draft zu speichern. Diese Werte anschließend beim Persistieren berücksichtigen.【F:src/Clusterer/MonthlyHighlightsClusterStrategy.php†L81-L140】【F:src/Clusterer/Support/ClusterQualityAggregator.php†L17-L109】【F:src/Service/Clusterer/ClusterPersistenceService.php†L264-L305】

### Paket D – Persistenz & Nachverarbeitung absichern
- [x] **Persistierte Parameter prüfen:** In `ClusterPersistenceService::buildMetadata()` sowie `ClusterEntityToDraftMapper` gezielt testen, ob neue Parameter (Personen, Bewegungsmetriken, Qualitätswerte) serialisiert und wiederhergestellt werden, damit Folgeheuristiken (Scoring, Feed) auf sie zugreifen können.【F:src/Service/Clusterer/ClusterPersistenceService.php†L264-L343】【F:test/Unit/Service/Clusterer/ClusterPersistenceServiceTest.php†L19-L198】【F:test/Unit/Support/ClusterEntityToDraftMapperTest.php†L19-L118】
- [x] **Scoring-Heuristiken validieren:** Die Heuristiken für Personen-, POI-, Qualitäts- und Recency-Bewertungen (`PeopleClusterScoreHeuristic`, `PoiClusterScoreHeuristic`, `QualityClusterScoreHeuristic`, `RecencyClusterScoreHeuristic`) in Unit-Tests gegen die neuen Parameter laufen lassen und bei Bedarf die Gewichtung anpassen.【F:test/Unit/Service/Clusterer/Scoring/PeopleClusterScoreHeuristicTest.php†L19-L82】【F:test/Unit/Service/Clusterer/Scoring/CompositeClusterScorerTest.php†L62-L174】
- [x] **Konsolidierungs-Pipeline aufräumen:** Die Stages speichern keine ungenutzten Konstruktor-Parameter mehr, und `StageSupportTrait::computeScore()` dokumentiert nun die erwarteten Listen-Typen – das reduziert PHPStan-Warnungen und verbessert die Lesbarkeit.【F:src/Service/Clusterer/Pipeline/AnnotationPruningStage.php†L23-L89】【F:src/Service/Clusterer/Pipeline/DuplicateCollapseStage.php†L23-L103】【F:src/Service/Clusterer/Pipeline/PerMediaCapStage.php†L23-L122】【F:src/Service/Clusterer/Pipeline/StageSupportTrait.php†L17-L105】

Mit diesen Anpassungen spiegeln die Cluster-Ergebnisse die reichhaltigen Metadaten der Bibliothek deutlich besser wider und schaffen eine belastbarere Grundlage für Scoring, Ranking und UI-Darstellung.
